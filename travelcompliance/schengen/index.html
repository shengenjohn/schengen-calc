<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Travel Compliance - Visual Schengen Calculator</title>
    <meta name="description" content="Visual Schengen 90/180 rule calculator with enhanced graphics and simple explanations">
    <meta name="theme-color" content="#2563eb">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header h1:hover {
            transform: scale(1.05);
        }

        .mode-toggle {
            background: rgba(255,255,255,0.2);
            border-radius: 25px;
            padding: 4px;
            display: inline-flex;
            margin-bottom: 20px;
        }

        .mode-btn {
            background: none;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .mode-btn.active {
            background: white;
            color: #2563eb;
            font-weight: 600;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        /* Subscription Status Styles */
        .subscription-status {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .usage-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #856404;
        }

        /* Status Dashboard */
        .status-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-color, #2563eb);
        }

        .status-number {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--accent-color, #2563eb);
        }

        .status-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 600;
        }

        .traffic-light {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .safe { background: #22c55e; --accent-color: #22c55e; }
        .caution { background: #f59e0b; --accent-color: #f59e0b; }
        .danger { background: #ef4444; --accent-color: #ef4444; }

        /* Progress Bars */
        .progress-container {
            margin: 20px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 25%, rgba(255,255,255,0.2) 25%, rgba(255,255,255,0.2) 50%, transparent 50%, transparent 75%, rgba(255,255,255,0.2) 75%);
            background-size: 20px 20px;
            animation: progress-stripes 1s linear infinite;
        }

        @keyframes progress-stripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        /* Timeline */
        .timeline {
            margin: 30px 0;
            position: relative;
        }

        .timeline-track {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            position: relative;
            margin: 20px 0;
        }

        .timeline-segment {
            position: absolute;
            height: 100%;
            border-radius: 4px;
            top: 0;
        }

        .timeline-marker {
            position: absolute;
            transform: translateX(-50%);
            top: -15px;
        }

        .timeline-marker .marker-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 3px solid;
            margin: 0 auto 5px;
        }

        .timeline-marker .marker-label {
            font-size: 12px;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Reset Explanation Card */
        .reset-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
        }

        .reset-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reset-details {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
        }

        .reset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .reset-item:last-child {
            border-bottom: none;
        }

        .reset-label {
            font-weight: 600;
            opacity: 0.9;
        }

        .reset-value {
            font-weight: 700;
            font-size: 16px;
        }

        /* Cleanup suggestions */
        .cleanup-card {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .cleanup-title {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cleanup-trip {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cleanup-btn {
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .cleanup-btn:hover {
            background: #d97706;
        }

        /* Developer Panel Styles */
        .dev-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 0.9rem;
            z-index: 1001;
            display: none;
            min-width: 280px;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 2px solid #ff6b6b;
        }

        .dev-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1002;
            display: flex !important;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
        }

        .dev-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .dev-toggle:active {
            transform: scale(0.95);
        }

        .dev-input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #555;
            border-radius: 8px;
            background: #333;
            color: white;
            font-size: 14px;
        }

        .dev-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .dev-btn:hover {
            background: #556bd8;
            transform: translateY(-1px);
        }

        .dev-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 9999;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Emergency Access Styles */
        .emergency-access {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 9999;
        }

        .emergency-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        /* Paywall Styles */
        .paywall-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .paywall-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
            animation: slideUp 0.3s ease;
        }

        .paywall-content h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .paywall-content p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .paywall-pricing {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .paywall-price {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .paywall-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .paywall-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .paywall-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .paywall-btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e1e5e9;
        }

        .square-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 15px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Simple Mode Styles */
        body.simple-mode .card {
            padding: 30px;
            font-size: 18px;
        }

        body.simple-mode .status-number {
            font-size: 72px;
        }

        body.simple-mode .explanation {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: block !important;
        }

        body.simple-mode .explanation-title {
            font-size: 20px;
            font-weight: bold;
            color: #0369a1;
            margin-bottom: 10px;
        }

        body.simple-mode .form-row {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        body.simple-mode .form-group label {
            font-size: 20px;
            margin-bottom: 12px;
        }

        body.simple-mode .country-select,
        body.simple-mode input[type="date"],
        body.simple-mode input[type="text"] {
            font-size: 18px;
            padding: 18px;
        }

        body.simple-mode .btn {
            font-size: 18px;
            padding: 20px;
        }

        body.simple-mode h3 {
            font-size: 24px;
        }

        body.simple-mode .trip-visual {
            padding: 20px;
            margin: 15px 0;
        }

        body.simple-mode .trip-dates {
            font-size: 18px;
        }

        body.simple-mode .trip-duration {
            font-size: 16px;
        }

        /* Hide complex features in simple mode */
        body.simple-mode #countryStats,
        body.simple-mode #resetExplanation,
        body.simple-mode #cleanupSuggestions,
        body.simple-mode .reset-card,
        body.simple-mode .cleanup-card {
            display: none !important;
        }

        body.simple-mode .timeline {
            display: none;
        }

        body.simple-mode .businessPrompt,
        body.simple-mode #businessPrompt {
            display: none !important;
        }

        /* Mobile responsive improvements */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .status-dashboard {
                grid-template-columns: 1fr;
            }
            
            .status-number {
                font-size: 36px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }

            .paywall-content {
                padding: 20px;
                margin: 10px;
            }

            .paywall-buttons {
                flex-direction: column;
            }

            .paywall-btn {
                width: 100%;
            }

            .dev-panel {
                bottom: 80px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Trip visualization */
        .trip-visual {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin: 10px 0;
            border-left: 4px solid;
            position: relative;
        }

        .trip-visual.past { border-color: #64748b; }
        .trip-visual.current { border-color: #ef4444; }
        .trip-visual.future { border-color: #22c55e; }

        .trip-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }

        .trip-details {
            flex: 1;
        }

        .trip-dates {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .trip-duration {
            font-size: 14px;
            color: #64748b;
        }

        .trip-actions {
            display: flex;
            gap: 8px;
        }

        .trip-delete {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .trip-delete:hover {
            background: #dc2626;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        input[type="date"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
        }

        input[type="date"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }

        /* Country Selection */
        .country-select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
            background: #fafafa;
        }

        .country-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Country visualization */
        .country-stats {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .country-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .country-item:last-child {
            border-bottom: none;
        }

        .country-flag {
            font-size: 20px;
            margin-right: 10px;
        }

        .country-name {
            font-weight: 600;
            flex: 1;
        }

        .country-days {
            background: #2563eb;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        /* Trip type indicators */
        .trip-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .trip-type.business {
            background: #dbeafe;
            color: #1e40af;
        }

        .trip-type.tourism {
            background: #dcfce7;
            color: #166534;
        }

        .trip-type.transit {
            background: #fef3c7;
            color: #92400e;
        }

        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üá™üá∫ Travel Compliance</h1>
            <div style="margin-bottom: 15px;">
                <a href="/" class="upgrade-btn" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 14px; margin-right: 10px;">‚Üê Back to Home</a>
                <a href="/subscribe.html" class="upgrade-btn" style="background: #10b981; color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 14px; font-weight: 600;">‚ö° Upgrade for Business</a>
            </div>
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('expert')">Expert Mode</button>
                <button class="mode-btn" onclick="setMode('simple')">Simple Mode</button>
            </div>
        </header>

        <!-- Subscription Status Display -->
        <div id="subscription-status" class="subscription-status" style="display: none;">
            <span id="subscription-text"></span>
        </div>

        <!-- Usage Warning for Free Users -->
        <div id="usage-warning" class="usage-warning" style="display: none;">
            <span id="usage-text"></span>
        </div>

        <!-- Business Upgrade Prompt -->
        <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-align: center;" id="businessPrompt">
            <h3 style="margin-bottom: 15px; color: white;">üíº Need This for Your Business?</h3>
            <p style="margin-bottom: 20px; opacity: 0.9;">Track multiple employees, get compliance reports, and never miss a violation with our Business plan.</p>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <a href="/subscribe.html" style="background: white; color: #059669; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600;">View Business Plans</a>
                <button onclick="hideBusinessPrompt()" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">Maybe Later</button>
            </div>
        </div>

        <!-- Status Dashboard -->
        <div class="status-dashboard">
            <div class="status-card" id="daysUsedCard">
                <div class="status-number" id="daysUsed">0</div>
                <div class="status-label">Days Used</div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="usedProgress" style="background: #ef4444; width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="status-card" id="daysLeftCard">
                <div class="traffic-light safe" id="trafficLight">üü¢</div>
                <div class="status-number" id="daysLeft">90</div>
                <div class="status-label">Days Remaining</div>
            </div>

            <div class="status-card">
                <div class="status-number" id="safetyLevel">SAFE</div>
                <div class="status-label">Travel Status</div>
            </div>
        </div>

        <!-- Simple Mode Explanation -->
        <div class="card explanation" id="simpleExplanation" style="display: none;">
            <div class="explanation-title">üéØ What This Means:</div>
            <p id="simpleExplanationText">You can visit Europe for 90 days every 6 months. Think of it like a video game - you get 90 "travel coins" that refill over time!</p>
        </div>

        <!-- Country Breakdown -->
        <div class="card" id="countryStats" style="display: none;">
            <h3 style="margin-bottom: 20px;">üåç Countries Visited</h3>
            <div id="countryBreakdown"></div>
            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 12px; margin-top: 15px; font-size: 14px;">
                <strong>üí° Business Tip:</strong> Track which countries you visit most for tax residency and work permit considerations.
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 20px;">üìÖ Your Travel Timeline</h3>
            <div class="timeline" id="timeline">
                <div class="timeline-track" id="timelineTrack"></div>
            </div>
        </div>

        <!-- Reset Explanation -->
        <div class="reset-card" id="resetExplanation" style="display: none;">
            <div class="reset-title">
                üîÑ Your Travel Days Reset Schedule
            </div>
            <div id="resetDetails"></div>
        </div>

        <!-- Cleanup Suggestions -->
        <div class="cleanup-card" id="cleanupSuggestions" style="display: none;">
            <div class="cleanup-title">
                üßπ Trip Cleanup Suggestions
            </div>
            <p style="margin-bottom: 12px; color: #92400e;">These old trips no longer affect your 90/180 calculation. You can safely delete them to keep your list clean:</p>
            <div id="cleanupList"></div>
        </div>

        <!-- Trip Planning Helper -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>üóìÔ∏è Plan Your Next Trip</h3>
                <a href="/subscribe.html" style="background: #f59e0b; color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 14px; font-weight: 600;">üìä Get Reports</a>
            </div>
            <div id="planningHelper"></div>
            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin-top: 15px; text-align: center;">
                <small style="color: #0369a1;">üí° <strong>Business users</strong> get automated alerts, PDF reports, and team dashboards. <a href="/subscribe.html" style="color: #0369a1; font-weight: 600;">Learn more ‚Üí</a></small>
            </div>
        </div>

        <!-- Add Trip Form -->
        <div class="card">
            <h3 style="margin-bottom: 20px;">‚úàÔ∏è Add Your Trip</h3>
            <form id="tripForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="entryDate">Entry Date</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="exitDate">Exit Date</label>
                        <input type="date" id="exitDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="country">Country/Countries Visited</label>
                        <select id="country" class="country-select" required>
                            <option value="">Select primary country...</option>
                            <option value="üá¶üáπ Austria">üá¶üáπ Austria</option>
                            <option value="üáßüá™ Belgium">üáßüá™ Belgium</option>
                            <option value="üáßüá¨ Bulgaria">üáßüá¨ Bulgaria</option>
                            <option value="üá≠üá∑ Croatia">üá≠üá∑ Croatia</option>
                            <option value="üá®üáø Czech Republic">üá®üáø Czech Republic</option>
                            <option value="üá©üá∞ Denmark">üá©üá∞ Denmark</option>
                            <option value="üá™üá™ Estonia">üá™üá™ Estonia</option>
                            <option value="üá´üáÆ Finland">üá´üáÆ Finland</option>
                            <option value="üá´üá∑ France">üá´üá∑ France</option>
                            <option value="üá©üá™ Germany">üá©üá™ Germany</option>
                            <option value="üá¨üá∑ Greece">üá¨üá∑ Greece</option>
                            <option value="üá≠üá∫ Hungary">üá≠üá∫ Hungary</option>
                            <option value="üáÆüá∏ Iceland">üáÆüá∏ Iceland</option>
                            <option value="üáÆüáπ Italy">üáÆüáπ Italy</option>
                            <option value="üá±üáª Latvia">üá±üáª Latvia</option>
                            <option value="üá±üáÆ Liechtenstein">üá±üáÆ Liechtenstein</option>
                            <option value="üá±üáπ Lithuania">üá±üáπ Lithuania</option>
                            <option value="üá±üá∫ Luxembourg">üá±üá∫ Luxembourg</option>
                            <option value="üá≤üáπ Malta">üá≤üáπ Malta</option>
                            <option value="üá≥üá± Netherlands">üá≥üá± Netherlands</option>
                            <option value="üá≥üá¥ Norway">üá≥üá¥ Norway</option>
                            <option value="üáµüá± Poland">üáµüá± Poland</option>
                            <option value="üáµüáπ Portugal">üáµüáπ Portugal</option>
                            <option value="üá∑üá¥ Romania">üá∑üá¥ Romania</option>
                            <option value="üá∏üá∞ Slovakia">üá∏üá∞ Slovakia</option>
                            <option value="üá∏üáÆ Slovenia">üá∏üáÆ Slovenia</option>
                            <option value="üá™üá∏ Spain">üá™üá∏ Spain</option>
                            <option value="üá∏üá™ Sweden">üá∏üá™ Sweden</option>
                            <option value="üá®üá≠ Switzerland">üá®üá≠ Switzerland</option>
                            <option value="üåç Multiple Countries">üåç Multiple Countries</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tripType">Trip Purpose</label>
                        <select id="tripType" class="country-select">
                            <option value="tourism">üèñÔ∏è Tourism/Leisure</option>
                            <option value="business">üíº Business Travel</option>
                            <option value="transit">‚úàÔ∏è Transit/Layover</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="tripNotes">Trip Notes (Optional)</label>
                    <input type="text" id="tripNotes" placeholder="e.g., Frankfurt conference, Berlin-Munich tour..." style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px;">
                </div>
                <button type="submit" class="btn">Add Trip</button>
                <button type="button" class="btn btn-secondary" onclick="clearAll()">Clear All Trips</button>
                
                <!-- Mobile backup/restore options -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <small style="color: #666; display: block; margin-bottom: 10px;">üì± iPhone Users: Backup Your Data</small>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" onclick="exportTrips()" style="flex: 1; padding: 8px; background: #f59e0b; color: white; border: none; border-radius: 6px; font-size: 14px;">üì§ Export</button>
                        <button type="button" onclick="importTrips()" style="flex: 1; padding: 8px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 14px;">üì• Import</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" onclick="copyTripsToClipboard()" style="flex: 1; padding: 8px; background: #6366f1; color: white; border: none; border-radius: 6px; font-size: 14px;">üìã Copy</button>
                        <button type="button" onclick="pasteTripsFromClipboard()" style="flex: 1; padding: 8px; background: #8b5cf6; color: white; border: none; border-radius: 6px; font-size: 14px;">üìã Paste</button>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #999;">
                        Export saves to Downloads folder. Import looks for .json files.
                    </div>
                </div>
            </form>
        </div>

        <!-- Trip List -->
        <div class="card">
            <h3 style="margin-bottom: 20px;">üéí Your European Adventures</h3>
            <div id="tripList">
                <div style="text-align: center; color: #64748b; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚úàÔ∏è</div>
                    <p>No trips recorded yet. Add your first European adventure above!</p>
                </div>
            </div>
        </div>

        <!-- Developer Panel (Hidden by default) -->
        <div id="dev-toggle" class="dev-toggle" onclick="toggleDevPanel()">üîß</div>
        
        <div id="dev-panel" class="dev-panel">
            <div style="margin-bottom: 15px; font-weight: bold; text-align: center; color: #ff6b6b;">üîß Developer Controls</div>
            
            <div id="dev-login" style="display: block;">
                <input type="password" id="dev-password" class="dev-input" placeholder="Enter developer password" />
                <button onclick="authenticateDeveloper()" class="dev-btn" style="width: 100%;">Login</button>
                <div style="font-size: 0.7rem; color: #ccc; margin-top: 8px; text-align: center;">
                    Password: travel2025dev
                </div>
            </div>
            
            <div id="dev-controls" style="display: none;">
                <div style="margin-bottom: 15px; color: #4CAF50; text-align: center; font-weight: 600;">‚úÖ Developer Authenticated</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button onclick="enableDeveloperMode()" class="dev-btn">Enable Dev Mode</button>
                    <button onclick="disableDeveloperMode()" class="dev-btn">Disable Dev Mode</button>
                    <button onclick="resetTrialAndUsage()" class="dev-btn">Reset Trial/Usage</button>
                    <button onclick="startDemoTrial()" class="dev-btn">Start Demo Trial</button>
                </div>
                <div style="margin-top: 15px; font-size: 0.75rem; color: #ccc; border-top: 1px solid #444; padding-top: 10px;">
                    <div><strong>Status:</strong> <span id="dev-status">Loading...</span></div>
                    <div style="margin-top: 5px;"><strong>Shortcuts:</strong></div>
                    <div>‚Ä¢ Ctrl+Shift+D = Enable Dev Mode</div>
                    <div>‚Ä¢ Ctrl+Shift+R = Reset Data</div>
                    <div>‚Ä¢ Ctrl+Shift+X = Disable Dev Mode</div>
                    <div>‚Ä¢ Triple-tap screen (mobile)</div>
                    <div>‚Ä¢ Double-click title</div>
                    <div>‚Ä¢ URL: ?dev=true</div>
                </div>
            </div>
        </div>

        <!-- Emergency Developer Access -->
        <div class="emergency-access">
            <button onclick="toggleDevPanel()" class="emergency-btn">üîß Dev</button>
        </div>
    </div>

    <script>
        // Safe element access utilities
        function safeElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element not found: ${id}`);
                return null;
            }
            return element;
        }

        function safeSetStyle(elementId, property, value) {
            const element = safeElement(elementId);
            if (element && element.style) {
                element.style[property] = value;
                return true;
            }
            return false;
        }

        function safeSetContent(elementId, content) {
            const element = safeElement(elementId);
            if (element) {
                element.textContent = content;
                return true;
            }
            return false;
        }

        function safeSetHTML(elementId, html) {
            const element = safeElement(elementId);
            if (element) {
                element.innerHTML = html;
                return true;
            }
            return false;
        }

        // Subscription and trial management
        function getSubscriptionStatus() {
            const trialEnd = localStorage.getItem('travelCompliance_trial_end');
            const trialActive = localStorage.getItem('travelCompliance_trial_active') === 'true';
            const hasSubscription = localStorage.getItem('travelCompliance_subscription') === 'active';
            const now = new Date().getTime();
            
            if (trialActive && trialEnd && now < parseInt(trialEnd)) {
                return { 
                    status: 'trial', 
                    daysLeft: Math.ceil((parseInt(trialEnd) - now) / (24 * 60 * 60 * 1000))
                };
            }
            
            if (hasSubscription) {
                return { status: 'subscribed' };
            }
            
            return { status: 'free' };
        }

        function updateSubscriptionStatus() {
            const status = getSubscriptionStatus();
            const subscriptionStatus = safeElement('subscription-status');
            const usageWarning = safeElement('usage-warning');
            const usageCount = parseInt(localStorage.getItem('travelCompliance_usage') || '0');
            
            // Hide all status displays first
            safeSetStyle('subscription-status', 'display', 'none');
            safeSetStyle('usage-warning', 'display', 'none');
            
            if (status.status === 'trial') {
                safeSetStyle('subscription-status', 'display', 'block');
                safeSetContent('subscription-text', `üéâ Free Trial Active - ${status.daysLeft} days remaining`);
            } else if (status.status === 'subscribed') {
                safeSetStyle('subscription-status', 'display', 'block');
                const statusElement = safeElement('subscription-status');
                if (statusElement) {
                    statusElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
                safeSetContent('subscription-text', '‚ú® Travel Compliance Pro - Unlimited Access');
            } else {
                safeSetStyle('usage-warning', 'display', 'block');
                const remaining = Math.max(0, 3 - usageCount);
                safeSetContent('usage-text', `Free calculations remaining: ${remaining}/3`);
            }
        }

        function incrementUsage() {
            const current = parseInt(localStorage.getItem('travelCompliance_usage') || '0');
            localStorage.setItem('travelCompliance_usage', (current + 1).toString());
            updateSubscriptionStatus();
        }

        function checkUsageLimit() {
            const status = getSubscriptionStatus();
            if (status.status !== 'free') {
                return true; // Unlimited for trial/subscription
            }
            
            const usageCount = parseInt(localStorage.getItem('travelCompliance_usage') || '0');
            return usageCount < 3; // 3 free calculations
        }

        function showPaywall() {
            const paywall = document.createElement('div');
            paywall.className = 'paywall-overlay';
            paywall.innerHTML = `
                <div class="paywall-content">
                    <h2>üîí Subscription Required</h2>
                    <p>You've used your 3 free calculations. To continue using the Schengen Calculator with unlimited access and advanced features, please subscribe to Travel Compliance Pro.</p>
                    
                    <div class="paywall-pricing">
                        <strong>‚ú® Travel Compliance Pro</strong>
                        <div class="paywall-price">¬£3.99<span style="font-size: 1rem; font-weight: normal;">/month</span></div>
                        <div style="background: rgba(76, 175, 80, 0.1); color: #2e7d32; padding: 8px; border-radius: 5px; margin: 10px 0; font-weight: 600;">
                            üéâ 14-day free trial included!
                        </div>
                        <p style="font-size: 0.9rem; margin: 10px 0;">
                            Unlimited calculations ‚Ä¢ Visual calendar ‚Ä¢ Travel history ‚Ä¢ Clear explanations ‚Ä¢ Direct support
                        </p>
                    </div>
                    
                    <div class="paywall-buttons">
                        <a href="/subscribe.html" class="paywall-btn paywall-btn-primary">
                            Start Free Trial
                        </a>
                        <button onclick="closePaywall()" class="paywall-btn paywall-btn-secondary">
                            ‚Üê Back to Home
                        </button>
                    </div>
                    
                    <div class="square-badge">
                        üí≥ Secure Square payments
                    </div>
                    
                    <p style="font-size: 0.8rem; margin-top: 20px; color: #999;">
                        No credit card required for trial ‚Ä¢ Cancel anytime ‚Ä¢ 30-day money-back guarantee
                    </p>
                </div>
            `;
            
            document.body.appendChild(paywall);
            
            // Track paywall show event
            trackEvent('paywall_shown', { trigger: 'usage_limit', payment_provider: 'square' });
        }

        function closePaywall() {
            const paywall = document.querySelector('.paywall-overlay');
            if (paywall) {
                paywall.remove();
            }
            // Redirect to home
            window.location.href = '/';
        }

        // Developer authentication and controls
        const DEV_PASSWORD = "travel2025dev"; // Change this to your preferred password
        let devAuthenticated = false;

        function toggleDevPanel() {
            const panel = safeElement('dev-panel');
            if (!panel) return;
            
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                updateDevStatus();
            }
        }

        function authenticateDeveloper() {
            const passwordElement = safeElement('dev-password');
            if (!passwordElement) return;
            
            const password = passwordElement.value;
            
            if (password === DEV_PASSWORD) {
                devAuthenticated = true;
                safeSetStyle('dev-login', 'display', 'none');
                safeSetStyle('dev-controls', 'display', 'block');
                updateDevStatus();
                
                // Auto-enable dev mode on first auth
                if (!isDeveloperMode()) {
                    enableDeveloperMode();
                }
            } else {
                alert('‚ùå Incorrect developer password');
                passwordElement.value = '';
            }
        }

        function updateDevStatus() {
            const statusElement = safeElement('dev-status');
            if (!statusElement) return;
            
            const status = getSubscriptionStatus();
            const devMode = isDeveloperMode();
            const usage = localStorage.getItem('travelCompliance_usage') || '0';
            
            statusElement.innerHTML = `
                Mode: ${devMode ? '<span style="color: #ff6b6b;">DEV</span>' : status.status}<br>
                Usage: ${usage}/3<br>
                ${status.daysLeft ? `Trial: ${status.daysLeft} days` : ''}
            `;
        }

        function enableDeveloperMode() {
            localStorage.setItem('travelCompliance_dev_mode', 'true');
            localStorage.setItem('travelCompliance_subscription', 'active');
            localStorage.setItem('travelCompliance_usage', '0');
            updateSubscriptionStatus();
            updateDevStatus();
            
            // Add visual indicator
            let devIndicator = document.querySelector('.dev-indicator');
            if (!devIndicator) {
                devIndicator = document.createElement('div');
                devIndicator.className = 'dev-indicator';
                devIndicator.innerHTML = 'üîß DEV MODE';
                document.body.appendChild(devIndicator);
            }
            
            alert('üîß Developer mode enabled! Unlimited access activated.');
        }

        function disableDeveloperMode() {
            localStorage.removeItem('travelCompliance_dev_mode');
            localStorage.removeItem('travelCompliance_subscription');
            localStorage.setItem('travelCompliance_usage', '0');
            updateSubscriptionStatus();
            updateDevStatus();
            
            // Remove visual indicator
            const devIndicator = document.querySelector('.dev-indicator');
            if (devIndicator) devIndicator.remove();
            
            alert('üîß Developer mode disabled! Back to normal operation.');
        }

        function resetTrialAndUsage() {
            localStorage.removeItem('travelCompliance_trial_end');
            localStorage.removeItem('travelCompliance_trial_active');
            localStorage.removeItem('travelCompliance_subscription');
            localStorage.removeItem('travelCompliance_user_email');
            localStorage.removeItem('travelCompliance_user_name');
            localStorage.setItem('travelCompliance_usage', '0');
            updateSubscriptionStatus();
            updateDevStatus();
            alert('üîÑ All data reset! Fresh user state.');
        }

        function startDemoTrial() {
            const trialEnd = new Date();
            trialEnd.setDate(trialEnd.getDate() + 14);
            
            localStorage.setItem('travelCompliance_trial_end', trialEnd.getTime().toString());
            localStorage.setItem('travelCompliance_trial_active', 'true');
            localStorage.setItem('travelCompliance_user_email', 'developer@test.com');
            localStorage.setItem('travelCompliance_user_name', 'Developer Test');
            localStorage.setItem('travelCompliance_usage', '0');
            updateSubscriptionStatus();
            updateDevStatus();
            alert('üéâ Demo trial started! 14-day trial active.');
        }

        // Emergency developer access methods
        let tapCount = 0;
        let tapTimer = null;

        // Triple-tap anywhere to open dev panel (mobile backup)
        document.addEventListener('touchstart', function(e) {
            tapCount++;
            if (tapTimer) clearTimeout(tapTimer);
            
            if (tapCount === 3) {
                toggleDevPanel();
                tapCount = 0;
            } else {
                tapTimer = setTimeout(() => {
                    tapCount = 0;
                }, 1000);
            }
        });

        // Double-click title to open dev panel (desktop backup)
        document.addEventListener('DOMContentLoaded', function() {
            const title = document.querySelector('h1');
            if (title) {
                title.addEventListener('dblclick', function() {
                    toggleDevPanel();
                });
                title.style.cursor = 'pointer';
                title.title = 'Double-click for developer access';
            }
        });

        // URL parameter bypass
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('dev') === 'true') {
                enableDeveloperMode();
                console.log('üîß Developer mode enabled via URL parameter');
            }
        }

        // Developer keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + Shift + D = Enable developer mode
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                enableDeveloperMode();
            }
            
            // Ctrl + Shift + R = Reset trial/usage
            if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                e.preventDefault();
                resetTrialAndUsage();
            }
            
            // Ctrl + Shift + X = Disable developer mode
            if (e.ctrlKey && e.shiftKey && e.key === 'X') {
                e.preventDefault();
                disableDeveloperMode();
            }
            
            // Ctrl + Shift + T = Toggle dev panel
            if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                e.preventDefault();
                toggleDevPanel();
            }
        });

        // Check if developer mode is active
        function isDeveloperMode() {
            return localStorage.getItem('travelCompliance_dev_mode') === 'true';
        }

        // Analytics tracking with error handling
        function trackEvent(eventName, properties) {
            try {
                const devMode = isDeveloperMode();
                console.log('Event:', eventName, { ...properties, dev_mode: devMode });
            } catch (error) {
                console.warn('Analytics tracking error:', error);
            }
        }

        // Original calculator variables and functions
        let trips = [];
        let isSimpleMode = false;

        // Set mode function
        window.setMode = function(mode) {
            isSimpleMode = mode === 'simple';
            
            if (isSimpleMode) {
                document.body.classList.add('simple-mode');
            } else {
                document.body.classList.remove('simple-mode');
            }
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'simple') {
                document.querySelector('.mode-btn:last-child').classList.add('active');
            } else {
                document.querySelector('.mode-btn:first-child').classList.add('active');
            }
            
            updateDisplay();
        };

        // Hide business prompt function
        window.hideBusinessPrompt = function() {
            const prompt = safeElement('businessPrompt');
            if (prompt) {
                prompt.style.display = 'none';
            }
        };

        // Delete trip function
        window.deleteTrip = function(tripId) {
            if (!checkUsageLimit()) {
                showPaywall();
                return;
            }
            
            const trip = trips.find(t => t.id === tripId);
            if (trip && confirm('Are you sure you want to delete this trip?')) {
                trips = trips.filter(t => t.id !== tripId);
                saveTrips();
                updateDisplay();
                incrementUsage();
            }
        };

        // Delete expired trip function
        window.deleteExpiredTrip = function(tripId) {
            if (!checkUsageLimit()) {
                showPaywall();
                return;
            }
            
            const trip = trips.find(t => t.id === tripId);
            if (trip && confirm(`Delete this old trip (${new Date(trip.entryDate).toLocaleDateString()} - ${new Date(trip.exitDate).toLocaleDateString()})?\n\nThis trip no longer affects your 90/180 calculation.`)) {
                trips = trips.filter(t => t.id !== tripId);
                saveTrips();
                updateDisplay();
                incrementUsage();
            }
        };

        // Export/Import functions for mobile backup
        window.exportTrips = function() {
            try {
                if (trips.length === 0) {
                    alert('No trips to export!');
                    return;
                }
                
                const data = {
                    trips: trips,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                
                // For iPhone: Try download first, then fallback to share
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    // iPhone-specific handling
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const filename = `travel-backup-${new Date().toISOString().split('T')[0]}.json`;
                    
                    // Try to trigger download
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    // Show iPhone-specific instructions
                    setTimeout(() => {
                        alert(`üì± iPhone Instructions:\n\n‚úÖ File saved to Downloads folder as "${filename}"\n\nüìÇ To access: Files app ‚Üí Downloads\nüí° Or use üìã Copy button for easier backup`);
                    }, 500);
                    
                } else {
                    // Desktop handling
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `travel-compliance-backup-${new Date().toISOString().split('T')[0]}.json`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    alert('‚úÖ Trips exported successfully!');
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå Export failed. Try the üìã Copy button instead.');
            }
        };

        window.importTrips = function() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,application/json';
                input.style.display = 'none';
                
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) {
                        // Show help if no file selected
                        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                            alert('üì± iPhone Help:\n\n1Ô∏è‚É£ First export your trips using üì§ Export\n2Ô∏è‚É£ File saves to Downloads folder\n3Ô∏è‚É£ Click üì• Import and select that file\n4Ô∏è‚É£ Look in "Files" app if you don\'t see it\n\nüí° Alternative: Use üìã Copy/Paste buttons');
                        }
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            const importedTrips = data.trips || data;
                            
                            if (!Array.isArray(importedTrips)) {
                                throw new Error('Invalid file format');
                            }
                            
                            // Merge with existing trips
                            const existingIds = new Set(trips.map(t => t.id));
                            let newTrips = 0;
                            
                            importedTrips.forEach(trip => {
                                if (!existingIds.has(trip.id)) {
                                    trips.push(trip);
                                    newTrips++;
                                }
                            });
                            
                            saveTrips();
                            updateDisplay();
                            alert(`‚úÖ Imported ${newTrips} new trips successfully!`);
                            
                        } catch (error) {
                            console.error('Import error:', error);
                            alert('‚ùå Could not read file. Make sure it\'s a valid backup file.');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
                
            } catch (error) {
                console.error('Import setup error:', error);
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    alert('üì± Import not working? Try üìã Paste instead!\n\n1Ô∏è‚É£ Use üìã Copy to backup\n2Ô∏è‚É£ Save the text somewhere\n3Ô∏è‚É£ Use üìã Paste to restore');
                } else {
                    alert('‚ùå Import failed. Try the paste option instead.');
                }
            }
        };

        // Copy/Paste functions for easier mobile use
        window.copyTripsToClipboard = function() {
            try {
                if (trips.length === 0) {
                    alert('No trips to copy!');
                    return;
                }
                
                const data = {
                    trips: trips,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(data);
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(dataStr).then(() => {
                        alert('üìã Trip data copied to clipboard!\n\nüí° Paste it in Notes app or email to save safely.\n\nTo restore: Come back and use üìã Paste button.');
                    }).catch(() => {
                        showTextToCopy(dataStr);
                    });
                } else {
                    showTextToCopy(dataStr);
                }
                
            } catch (error) {
                console.error('Copy error:', error);
                alert('‚ùå Copy failed. Try the export option instead.');
            }
        };

        window.pasteTripsFromClipboard = function() {
            try {
                if (navigator.clipboard && navigator.clipboard.readText) {
                    navigator.clipboard.readText().then(text => {
                        processImportedText(text);
                    }).catch(() => {
                        showPastePrompt();
                    });
                } else {
                    showPastePrompt();
                }
            } catch (error) {
                console.error('Paste error:', error);
                showPastePrompt();
            }
        };

        function showTextToCopy(dataStr) {
            const shortData = dataStr.length > 1000 ? dataStr.substring(0, 1000) + '...' : dataStr;
            const result = prompt('üìã Copy this text to save your trips:', shortData);
            if (result !== null) {
                alert('üíæ Save this text in Notes app or email. Use üìã Paste to restore later.');
            }
        }

        function showPastePrompt() {
            const data = prompt('üìã Paste your trip backup data here:');
            if (data) {
                processImportedText(data);
            }
        }

        function processImportedText(text) {
            try {
                const data = JSON.parse(text);
                const importedTrips = data.trips || data;
                
                if (!Array.isArray(importedTrips)) {
                    throw new Error('Invalid format');
                }
                
                const existingIds = new Set(trips.map(t => t.id));
                let newTrips = 0;
                
                importedTrips.forEach(trip => {
                    if (!existingIds.has(trip.id)) {
                        trips.push(trip);
                        newTrips++;
                    }
                });
                
                saveTrips();
                updateDisplay();
                alert(`‚úÖ Restored ${newTrips} trips successfully!`);
                
            } catch (error) {
                console.error('Paste processing error:', error);
                alert('‚ùå Invalid backup data. Make sure you copied the complete text from üìã Copy.');
            }
        }

        // Clear all function
        window.clearAll = function() {
            if (!checkUsageLimit()) {
                showPaywall();
                return;
            }
            
            if (confirm('Are you sure you want to clear all trips?')) {
                trips = [];
                saveTrips();
                updateDisplay();
                incrementUsage();
            }
        };

        // Storage detection and fallback system
        let storageAvailable = false;
        let storageMethod = 'none';

        function testStorage() {
            try {
                const testKey = 'storageTest';
                const testValue = 'test';
                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved === testValue) {
                    storageAvailable = true;
                    storageMethod = 'localStorage';
                    return true;
                }
            } catch (error) {
                console.warn('localStorage not available:', error);
            }
            
            // Fallback: warn user about storage limitations
            showStorageWarning();
            storageMethod = 'session';
            return false;
        }

        function showStorageWarning() {
            // Only show once per session
            if (sessionStorage.getItem('storage_warning_shown')) return;
            
            const warning = document.createElement('div');
            warning.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: #ff9800;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 10000;
                font-weight: 600;
                text-align: center;
                max-width: 90%;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            warning.innerHTML = `
                üì± iPhone Storage Issue Detected<br>
                <small>Your trips may not be saved between sessions. Try:</small><br>
                <small>‚Ä¢ Exit Private Browsing ‚Ä¢ Add to Home Screen ‚Ä¢ Free up iPhone storage</small>
            `;
            
            document.body.appendChild(warning);
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                if (warning.parentNode) {
                    warning.remove();
                }
            }, 8000);
            
            // Mark as shown
            try {
                sessionStorage.setItem('storage_warning_shown', 'true');
            } catch (e) {}
        }

        // Enhanced load trips with storage detection
        function loadTrips() {
            try {
                if (storageAvailable) {
                    const saved = localStorage.getItem('schengenTrips');
                    trips = saved ? JSON.parse(saved) : [];
                    console.log(`‚úÖ Loaded ${trips.length} trips from localStorage`);
                } else {
                    // Try to load from sessionStorage as fallback
                    const saved = sessionStorage.getItem('schengenTrips_session');
                    trips = saved ? JSON.parse(saved) : [];
                    console.log(`‚ö†Ô∏è Loaded ${trips.length} trips from sessionStorage (temporary)`);
                }
            } catch (error) {
                console.error('Error loading trips:', error);
                trips = [];
            }
        }

        // Enhanced save trips with fallback
        function saveTrips() {
            try {
                const tripsData = JSON.stringify(trips);
                
                if (storageAvailable) {
                    localStorage.setItem('schengenTrips', tripsData);
                    console.log(`‚úÖ Saved ${trips.length} trips to localStorage`);
                } else {
                    // Fallback to sessionStorage (lost on browser close)
                    sessionStorage.setItem('schengenTrips_session', tripsData);
                    console.log(`‚ö†Ô∏è Saved ${trips.length} trips to sessionStorage (temporary)`);
                }
                
                // Show save confirmation to user
                showSaveStatus();
                
            } catch (error) {
                console.error('Error saving trips:', error);
                showSaveError();
            }
        }

        function showSaveStatus() {
            const status = document.createElement('div');
            status.style.cssText = `
                position: fixed;
                bottom: 100px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 10px 15px;
                border-radius: 20px;
                z-index: 9999;
                font-size: 14px;
                font-weight: 600;
            `;
            status.textContent = storageAvailable ? '‚úÖ Trip saved' : '‚ö†Ô∏è Trip saved (temporary)';
            
            document.body.appendChild(status);
            
            setTimeout(() => {
                if (status.parentNode) {
                    status.remove();
                }
            }, 2000);
        }

        function showSaveError() {
            const error = document.createElement('div');
            error.style.cssText = `
                position: fixed;
                bottom: 100px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 10px 15px;
                border-radius: 20px;
                z-index: 9999;
                font-size: 14px;
                font-weight: 600;
            `;
            error.textContent = '‚ùå Could not save trip';
            
            document.body.appendChild(error);
            
            setTimeout(() => {
                if (error.parentNode) {
                    error.remove();
                }
            }, 3000);
        }

        // Calculate days between dates
        function calculateDaysBetween(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }

        // Calculate status
        function calculateStatus() {
            const today = new Date();
            const windowStart = new Date(today);
            windowStart.setDate(today.getDate() - 179);
            
            let totalDaysUsed = 0;
            let earliestTripDate = null;

            trips.forEach(trip => {
                const entryDate = new Date(trip.entryDate);
                const exitDate = new Date(trip.exitDate);
                
                if (exitDate >= windowStart) {
                    const tripStart = entryDate > windowStart ? entryDate : windowStart;
                    const tripEnd = exitDate < today ? exitDate : today;
                    
                    if (tripStart <= tripEnd) {
                        const daysInWindow = calculateDaysBetween(
                            tripStart.toISOString().split('T')[0],
                            tripEnd.toISOString().split('T')[0]
                        );
                        totalDaysUsed += daysInWindow;
                        
                        if (!earliestTripDate || entryDate < earliestTripDate) {
                            earliestTripDate = entryDate;
                        }
                    }
                }
            });

            const remainingDays = Math.max(0, 90 - totalDaysUsed);
            
            let nextResetDate = null;
            let daysUntilReset = null;
            if (earliestTripDate) {
                nextResetDate = new Date(earliestTripDate);
                nextResetDate.setDate(nextResetDate.getDate() + 180);
                daysUntilReset = Math.ceil((nextResetDate - today) / (1000 * 60 * 60 * 24));
            }

            return {
                used: totalDaysUsed,
                remaining: remainingDays,
                nextReset: nextResetDate,
                daysUntilReset: daysUntilReset,
                earliestTripDays: earliestTripDate ? trips.find(trip => new Date(trip.entryDate).getTime() === earliestTripDate.getTime())?.days || 0 : 0
            };
        }

        // Update display with error handling
        function updateDisplay() {
            try {
                const status = calculateStatus();
                
                // Update numbers safely
                safeSetContent('daysUsed', status.used.toString());
                safeSetContent('daysLeft', status.remaining.toString());
                
                // Update progress bar safely
                const usedPercent = (status.used / 90) * 100;
                const progressEl = safeElement('usedProgress');
                if (progressEl) progressEl.style.width = usedPercent + '%';
                
                // Update traffic light safely
                updateTrafficLight(status);
                updateSimpleExplanation(status);
                updateResetExplanation(status);
                updateCleanupSuggestions();
                updateCountryStats();
                updateTimeline();
                updatePlanningHelper();
                updateTripList();
            } catch (error) {
                console.error('Display update error:', error);
            }
        }

        // Update traffic light
        function updateTrafficLight(status) {
            try {
                const trafficLight = safeElement('trafficLight');
                const safetyLevel = safeElement('safetyLevel');
                const daysLeftCard = safeElement('daysLeftCard');
                
                if (!trafficLight || !safetyLevel || !daysLeftCard) return;
                
                if (status.remaining >= 60) {
                    trafficLight.textContent = 'üü¢';
                    trafficLight.className = 'traffic-light safe';
                    safetyLevel.textContent = 'SAFE';
                    daysLeftCard.style.setProperty('--accent-color', '#22c55e');
                } else if (status.remaining >= 30) {
                    trafficLight.textContent = 'üü°';
                    trafficLight.className = 'traffic-light caution';
                    safetyLevel.textContent = 'CAUTION';
                    daysLeftCard.style.setProperty('--accent-color', '#f59e0b');
                } else {
                    trafficLight.textContent = 'üî¥';
                    trafficLight.className = 'traffic-light danger';
                    safetyLevel.textContent = 'DANGER';
                    daysLeftCard.style.setProperty('--accent-color', '#ef4444');
                }
            } catch (error) {
                console.error('Traffic light update error:', error);
            }
        }

        // Update simple explanation
        function updateSimpleExplanation(status) {
            try {
                const explanation = safeElement('simpleExplanation');
                const explanationText = safeElement('simpleExplanationText');
                
                if (!explanation || !explanationText) return;
                
                if (isSimpleMode) {
                    explanation.style.display = 'block';
                    if (status.remaining >= 60) {
                        explanationText.textContent = `Great! You have ${status.remaining} vacation days left in Europe. That's enough for a long holiday! üèñÔ∏è`;
                    } else if (status.remaining >= 30) {
                        explanationText.textContent = `You have ${status.remaining} vacation days left in Europe. Perfect for a nice trip! ‚úàÔ∏è`;
                    } else if (status.remaining > 0) {
                        explanationText.textContent = `Careful! You only have ${status.remaining} vacation days left in Europe. Plan your next trip wisely! ‚ö†Ô∏è`;
                    } else {
                        explanationText.textContent = `Oh no! You've used all your Europe vacation days this period. You need to wait for them to refresh! üîÑ`;
                    }
                } else {
                    explanation.style.display = 'none';
                }
            } catch (error) {
                console.error('Simple explanation error:', error);
            }
        }

        // Update reset explanation
        function updateResetExplanation(status) {
            const resetCard = safeElement('resetExplanation');
            const resetDetails = safeElement('resetDetails');
            
            if (!resetCard || !resetDetails) return;
            
            if (!status.nextReset || status.daysUntilReset <= 0) {
                resetCard.style.display = 'none';
                return;
            }
            
            resetCard.style.display = 'block';
            
            const resetTrip = trips.find(trip => {
                const entryDate = new Date(trip.entryDate);
                const resetDate = new Date(entryDate);
                resetDate.setDate(entryDate.getDate() + 180);
                return Math.abs(resetDate - status.nextReset) < 24 * 60 * 60 * 1000;
            });
            
            const resetTripDays = resetTrip ? resetTrip.days : status.earliestTripDays;
            const resetTripDates = resetTrip ? `${new Date(resetTrip.entryDate).toLocaleDateString()} - ${new Date(resetTrip.exitDate).toLocaleDateString()}` : 'your earliest trip';
            const totalAfterReset = status.remaining + resetTripDays;
            
            resetDetails.innerHTML = `
                <div class="reset-item">
                    <span class="reset-label">Days until reset</span>
                    <span class="reset-value">${status.daysUntilReset} days</span>
                </div>
                <div class="reset-item">
                    <span class="reset-label">Reset date</span>
                    <span class="reset-value">${status.nextReset.toLocaleDateString()}</span>
                </div>
                <div class="reset-item">
                    <span class="reset-label">Trip ending (${resetTripDates})</span>
                    <span class="reset-value">${resetTripDays} days</span>
                </div>
                <div class="reset-item">
                    <span class="reset-label">Days after reset</span>
                    <span class="reset-value">${totalAfterReset}/90 days</span>
                </div>
            `;
        }

        // Update cleanup suggestions
        function updateCleanupSuggestions() {
            const cleanupCard = safeElement('cleanupSuggestions');
            const cleanupList = safeElement('cleanupList');
            
            if (!cleanupCard || !cleanupList) return;
            
            const today = new Date();
            const cutoffDate = new Date(today);
            cutoffDate.setDate(today.getDate() - 180);
            
            const expiredTrips = trips.filter(trip => {
                const exitDate = new Date(trip.exitDate);
                return exitDate < cutoffDate;
            });
            
            if (expiredTrips.length === 0) {
                cleanupCard.style.display = 'none';
                return;
            }
            
            cleanupCard.style.display = 'block';
            
            const cleanupHTML = expiredTrips.map(trip => `
                <div class="cleanup-trip">
                    <div>
                        <strong>${trip.country}</strong><br>
                        <small>${new Date(trip.entryDate).toLocaleDateString()} - ${new Date(trip.exitDate).toLocaleDateString()}</small>
                    </div>
                    <button onclick="deleteExpiredTrip('${trip.id}')" class="cleanup-btn">Delete</button>
                </div>
            `).join('');
            
            cleanupList.innerHTML = cleanupHTML;
        }

        // Update country stats
        function updateCountryStats() {
            const countryStats = safeElement('countryStats');
            const countryBreakdown = safeElement('countryBreakdown');
            
            if (!countryStats || !countryBreakdown) return;
            
            if (trips.length === 0) {
                countryStats.style.display = 'none';
                return;
            }
            
            countryStats.style.display = 'block';
            
            const countryTotals = {};
            trips.forEach(trip => {
                const country = trip.country;
                if (!countryTotals[country]) {
                    countryTotals[country] = 0;
                }
                countryTotals[country] += trip.days;
            });
            
            const sortedCountries = Object.entries(countryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            const countryHTML = sortedCountries.map(([country, days]) => `
                <div class="country-item">
                    <span class="country-name">${country}</span>
                    <span class="country-days">${days} days</span>
                </div>
            `).join('');
            
            countryBreakdown.innerHTML = `
                <div class="country-stats">
                    ${countryHTML}
                </div>
            `;
        }

        // Update timeline
        function updateTimeline() {
            const timelineTrack = safeElement('timelineTrack');
            if (!timelineTrack) return;
            
            const today = new Date();
            const sixMonthsAgo = new Date(today);
            sixMonthsAgo.setDate(today.getDate() - 180);
            
            const timelineTrips = trips.filter(trip => {
                const exitDate = new Date(trip.exitDate);
                return exitDate >= sixMonthsAgo;
            });
            
            if (timelineTrips.length === 0) {
                timelineTrack.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">No trips in the current 180-day window</div>';
                return;
            }
            
            timelineTrack.innerHTML = '';
            
            const totalDays = 180;
            
            timelineTrips.forEach(trip => {
                const entryDate = new Date(trip.entryDate);
                const exitDate = new Date(trip.exitDate);
                
                const tripStart = Math.max(0, Math.floor((entryDate - sixMonthsAgo) / (1000 * 60 * 60 * 24)));
                const tripEnd = Math.min(180, Math.floor((exitDate - sixMonthsAgo) / (1000 * 60 * 60 * 24)));
                
                if (tripStart < 180 && tripEnd > 0) {
                    const leftPercent = (tripStart / totalDays) * 100;
                    const widthPercent = ((tripEnd - tripStart) / totalDays) * 100;
                    
                    const segment = document.createElement('div');
                    segment.className = 'timeline-segment';
                    segment.style.left = leftPercent + '%';
                    segment.style.width = widthPercent + '%';
                    segment.style.background = '#2563eb';
                    segment.title = `${trip.country}: ${new Date(trip.entryDate).toLocaleDateString()} - ${new Date(trip.exitDate).toLocaleDateString()}`;
                    
                    timelineTrack.appendChild(segment);
                }
            });
            
            // Add "today" marker
            const todayPosition = ((today - sixMonthsAgo) / (1000 * 60 * 60 * 24) / totalDays) * 100;
            const todayMarker = document.createElement('div');
            todayMarker.className = 'timeline-marker';
            todayMarker.style.left = todayPosition + '%';
            todayMarker.innerHTML = `
                <div class="marker-dot" style="border-color: #ef4444;"></div>
                <div class="marker-label" style="color: #ef4444;">Today</div>
            `;
            timelineTrack.appendChild(todayMarker);
        }

        // Update planning helper
        function updatePlanningHelper() {
            const planningHelper = safeElement('planningHelper');
            if (!planningHelper) return;
            
            const status = calculateStatus();
            const today = new Date();
            
            let planningHTML = '';
            
            if (status.remaining > 60) {
                planningHTML = `
                    <div style="color: #059669; font-weight: 600; margin-bottom: 10px;">‚úÖ You're in great shape for travel!</div>
                    <p>With ${status.remaining} days remaining, you can plan a long European adventure. Consider:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Extended business travel (up to ${Math.floor(status.remaining * 0.8)} days)</li>
                        <li>Multi-country tours</li>
                        <li>Seasonal relocations</li>
                    </ul>
                `;
            } else if (status.remaining > 30) {
                planningHTML = `
                    <div style="color: #d97706; font-weight: 600; margin-bottom: 10px;">‚ö†Ô∏è Plan your next trips carefully</div>
                    <p>With ${status.remaining} days remaining, consider shorter trips or wait for your days to reset.</p>
                    ${status.nextReset ? `<p><strong>Your next reset:</strong> ${status.nextReset.toLocaleDateString()} (${status.daysUntilReset} days)</p>` : ''}
                `;
            } else if (status.remaining > 0) {
                planningHTML = `
                    <div style="color: #dc2626; font-weight: 600; margin-bottom: 10px;">üö® Very limited travel days left</div>
                    <p>Only ${status.remaining} days remaining! Use them wisely for essential travel only.</p>
                    ${status.nextReset ? `<p><strong>Next reset:</strong> ${status.nextReset.toLocaleDateString()} (${status.daysUntilReset} days)</p>` : ''}
                `;
            } else {
                planningHTML = `
                    <div style="color: #dc2626; font-weight: 600; margin-bottom: 10px;">üîí No travel days remaining</div>
                    <p>You've used all 90 days in the current 180-day period. You cannot enter the Schengen area until your days reset.</p>
                    ${status.nextReset ? `<p><strong>Next reset:</strong> ${status.nextReset.toLocaleDateString()} (${status.daysUntilReset} days)</p>` : ''}
                `;
            }
            
            planningHelper.innerHTML = planningHTML;
        }

        // Update trip list
        function updateTripList() {
            const tripList = safeElement('tripList');
            if (!tripList) return;
            
            if (trips.length === 0) {
                tripList.innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úàÔ∏è</div>
                        <p>No trips recorded yet. Add your first European adventure above!</p>
                    </div>
                `;
                return;
            }
            
            const today = new Date();
            const sortedTrips = [...trips].sort((a, b) => new Date(b.entryDate) - new Date(a.entryDate));
            
            const tripHTML = sortedTrips.map(trip => {
                const entryDate = new Date(trip.entryDate);
                const exitDate = new Date(trip.exitDate);
                const isPast = exitDate < today;
                const isCurrent = entryDate <= today && exitDate >= today;
                const isFuture = entryDate > today;
                
                let status = 'past';
                let icon = 'üìÖ';
                if (isCurrent) {
                    status = 'current';
                    icon = 'üè®';
                } else if (isFuture) {
                    status = 'future';
                    icon = '‚úàÔ∏è';
                }
                
                const typeIcon = trip.tripType === 'business' ? 'üíº' : trip.tripType === 'transit' ? '‚úàÔ∏è' : 'üèñÔ∏è';
                
                return `
                    <div class="trip-visual ${status}">
                        <div class="trip-icon">${icon}</div>
                        <div class="trip-details">
                            <div class="trip-dates">
                                ${trip.country}
                                <span class="trip-type ${trip.tripType}">${typeIcon} ${trip.tripType}</span>
                            </div>
                            <div class="trip-duration">
                                ${entryDate.toLocaleDateString()} - ${exitDate.toLocaleDateString()} (${trip.days} days)
                                ${trip.notes ? `<br><em>${trip.notes}</em>` : ''}
                            </div>
                        </div>
                        <div class="trip-actions">
                            <button onclick="deleteTrip('${trip.id}')" class="trip-delete">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            tripList.innerHTML = tripHTML;
        }

        // Form submission
        document.addEventListener('DOMContentLoaded', function() {
            const tripForm = safeElement('tripForm');
            if (tripForm) {
                tripForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (!checkUsageLimit()) {
                        showPaywall();
                        return;
                    }
                    
                    const entryDate = safeElement('entryDate').value;
                    const exitDate = safeElement('exitDate').value;
                    const country = safeElement('country').value;
                    const tripType = safeElement('tripType').value;
                    const tripNotes = safeElement('tripNotes').value;
                    
                    if (!entryDate || !exitDate || !country) {
                        alert('Please fill in all required fields');
                        return;
                    }
                    
                    if (new Date(exitDate) < new Date(entryDate)) {
                        alert('Exit date must be after entry date');
                        return;
                    }
                    
                    const days = calculateDaysBetween(entryDate, exitDate);
                    
                    const trip = {
                        id: Date.now().toString(),
                        entryDate,
                        exitDate,
                        country,
                        tripType,
                        notes: tripNotes,
                        days
                    };
                    
                    trips.push(trip);
                    saveTrips();
                    updateDisplay();
                    incrementUsage();
                    
                    // Reset form
                    tripForm.reset();
                    
                    // Track trip added
                    trackEvent('trip_added', { country, days, trip_type: tripType });
                });
            }
            
            // Initialize the app
            loadTrips();
            updateSubscriptionStatus();
            updateDisplay();
            checkUrlParams();
        });
    </script>
</body>
</html>